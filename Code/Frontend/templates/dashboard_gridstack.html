<!DOCTYPE html>
<html>
<head>
    <title>RaceLink Telemetry - GridStack</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/8.4.0/gridstack.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/8.4.0/gridstack-all.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #fff;
        }
        
        .header {
            background: #0a0a0a;
            padding: 15px 20px;
            border-bottom: 2px solid #031fe6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .header-logo {
            height: 50px;
        }
        
        .header-title {
            color: #031fe6;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 0 10px #031fe6;
        }
        
        .status-bar {
            display: flex;
            gap: 20px;
            padding: 10px 20px;
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        
        .status-value {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            font-family: 'Courier New', monospace;
        }
        
        .status-label {
            font-size: 10px;
            color: #aaa;
        }
        
        .connection-status {
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .connection-status.connected {
            background: #00ff88;
            color: #000;
        }
        
        .connection-status.disconnected {
            background: #ff3333;
            color: #fff;
        }
        
        .controls {
            padding: 10px 20px;
            background: #0a0a0a;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 10px;
        }
        
        .controls button {
            padding: 8px 15px;
            background: #031fe6;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .controls button:hover {
            background: #0428ff;
        }
        
        .controls button.active {
            background: #00ff88;
            color: #000;
        }
        
        #gridContainer {
            position: absolute;
            top: 170px;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 10px;
        }
        
        .grid-stack {
            background: #1a1a1a;
        }
        
        .grid-stack-item {
            background: rgba(3, 31, 230, 0.05);
            border: 1px solid #333;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .grid-stack-item-content {
            background: rgba(3, 31, 230, 0.05);
            padding: 10px;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .chart-title {
            color: #031fe6;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .chart-wrapper {
            flex: 1;
            position: relative;
            min-height: 0;
        }
        
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
        
        .gs-w {
            cursor: grab;
        }
        
        .gs-w.ui-draggable-dragging {
            cursor: grabbing;
            opacity: 0.8;
        }
        
        .gs-resize-handle {
            background: linear-gradient(135deg, transparent 50%, #031fe6 50%);
            opacity: 0.5;
            z-index: 10;
        }
        
        .gs-resize-handle:hover {
            opacity: 1;
        }
        .toolbar {
            position: fixed;
            top: 170px;
            right: 0;
            z-index: 200;
            background: #0a0a0a;
            border-left: 1px solid #333;
        }

        .toolbar-toggle {
            padding: 10px 15px;
            background: #031fe6;
            color: #fff;
            border: none;
            cursor: pointer;
            font-weight: bold;
            writing-mode: vertical-rl;
            transform: rotate(180deg);
        }

        .toolbar-toggle:hover {
            background: #0428ff;
        }

        .toolbar-panel {
            position: absolute;
            right: 100%;
            top: 0;
            background: #0a0a0a;
            border: 1px solid #333;
            border-right: none;
            min-width: 180px;
            display: flex;
            flex-direction: column;
        }

        .toolbar-title {
            padding: 10px;
            color: #031fe6;
            font-size: 11px;
            font-weight: bold;
            border-bottom: 1px solid #333;
            text-transform: uppercase;
        }

        .toolbar-panel button {
            padding: 8px 10px;
            background: transparent;
            color: #aaa;
            border: none;
            border-bottom: 1px solid #333;
            text-align: left;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.2s;
        }

        .toolbar-panel button:hover {
            background: rgba(3, 31, 230, 0.2);
            color: #fff;
        }

        .toolbar-panel button:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <img src="/static/cropped-338345294_778307876971630_8269203501290917883_n-1.jpg" alt="Team Logo" class="header-logo">
            <div class="header-title">‚ö° RaceLink Telemetry</div>
        </div>
        <div class="status-bar">
            <div class="status-item">
                <div class="status-value" id="speed">0</div>
                <div class="status-label">km/h</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="throttle">0%</div>
                <div class="status-label">Throttle</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="gear">N</div>
                <div class="status-label">Gear</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="rssi">--</div>
                <div class="status-label">RSSI</div>
            </div>
            <div class="connection-status connected" id="connectionStatus">‚óè Connected</div>
        </div>
    </div>
    
    <div class="controls">
        <button class="active" onclick="switchMode('live')">‚óâ Live</button>
        <button onclick="switchMode('replay')">‚ü≥ Replay</button>
        <button onclick="resetLayout()">‚ü≤ Reset Layout</button>
        <button onclick="startRecording()">‚óè Record</button>
        <button onclick="stopRecording()">‚èπ Stop</button>
    </div>
    <div class="toolbar">
        <button class="toolbar-toggle" onclick="toggleToolbar()">‚ò∞ Widgets</button>
        <div class="toolbar-panel" id="toolbarPanel" style="display: none;">
            <div class="toolbar-title">Available Widgets</div>
            <button onclick="addWidget('speed', 'üèÅ Speed & Throttle')">+ Speed</button>
            <button onclick="addWidget('temp', 'üîß Engine Temps')">+ Temps</button>
            <button onclick="addWidget('fuel', 'üå°Ô∏è Fuel & Lambda')">+ Fuel</button>
            <button onclick="addWidget('accel', 'üí® Acceleration')">+ Accel</button>
            <button onclick="addWidget('pressure', 'üõ¢Ô∏è Oil & Brake')">+ Pressure</button>
            <button onclick="addWidget('signal', 'üì° Signal')">+ Signal</button>
        </div>
    </div>
    <div id="gridContainer">
        <div class="grid-stack" gs-animate="yes">
            <div class="grid-stack-item" gs-w="6" gs-h="4">
                <div class="grid-stack-item-content">
                    <div class="chart-title">üèÅ Speed & Throttle</div>
                    <div class="chart-wrapper"><canvas id="speedChart"></canvas></div>
                </div>
            </div>
            <div class="grid-stack-item" gs-w="6" gs-h="4">
                <div class="grid-stack-item-content">
                    <div class="chart-title">üîß Engine Temps</div>
                    <div class="chart-wrapper"><canvas id="tempChart"></canvas></div>
                </div>
            </div>
            <div class="grid-stack-item" gs-w="6" gs-h="4">
                <div class="grid-stack-item-content">
                    <div class="chart-title">üì° Signal Quality</div>
                    <div class="chart-wrapper"><canvas id="signalChart"></canvas></div>
                </div>
            </div>
            <div class="grid-stack-item" gs-w="6" gs-h="4">
                <div class="grid-stack-item-content">
                    <div class="chart-title">üå°Ô∏è Fuel & Lambda</div>
                    <div class="chart-wrapper"><canvas id="fuelChart"></canvas></div>
                </div>
            </div>
            <div class="grid-stack-item" gs-w="6" gs-h="4">
                <div class="grid-stack-item-content">
                    <div class="chart-title">üí® Acceleration</div>
                    <div class="chart-wrapper"><canvas id="accelChart"></canvas></div>
                </div>
            </div>
            <div class="grid-stack-item" gs-w="6" gs-h="4">
                <div class="grid-stack-item-content">
                    <div class="chart-title">üõ¢Ô∏è Oil & Brake</div>
                    <div class="chart-wrapper"><canvas id="pressureChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let charts = {};
        let grid = null;
        const maxDataPoints = 50;
        let mode = 'live';
        
        const colors = {
            red: 'rgb(255, 99, 132)',
            blue: 'rgb(54, 162, 235)',
            yellow: 'rgb(255, 206, 86)',
            green: 'rgb(75, 192, 75)',
            purple: 'rgb(153, 102, 255)',
            orange: 'rgb(255, 159, 64)',
            cyan: 'rgb(75, 192, 192)',
            pink: 'rgb(255, 159, 192)'
        };
        
        // Initialize GridStack
        window.addEventListener('load', function() {
            grid = GridStack.init({
                margin: 10,
                cellHeight: 'auto',
                disableOneColumnMode: false,
                animate: true
            });
            
            // Save layout on change
            grid.on('change', function() {
                saveLayout();
            });
            
            initCharts();
            loadLayout();
        });
        
        function initCharts() {
            charts.speed = createMultiChart('speedChart', [
                { label: 'Speed (km/h)', color: colors.blue },
                { label: 'Throttle (%)', color: colors.orange }
            ]);
            
            charts.temp = createMultiChart('tempChart', [
                { label: 'AGT (¬∞C)', color: colors.red },
                { label: 'EGT (¬∞C)', color: colors.orange },
                { label: 'Water (¬∞C)', color: colors.blue },
                { label: 'Oil (¬∞C)', color: colors.purple }
            ]);
            
            charts.fuel = createMultiChart('fuelChart', [
                { label: 'Fuel Level (%)', color: colors.green },
                { label: 'Lambda', color: colors.yellow }
            ]);
            
            charts.accel = createChart('accelChart', 'Acceleration (g)', colors.pink);
            
            charts.pressure = createMultiChart('pressureChart', [
                { label: 'Oil Pressure (bar)', color: colors.purple },
                { label: 'Brake Pressure (bar)', color: colors.red }
            ]);
            
            charts.signal = createMultiChart('signalChart', [
                { label: 'RSSI (dBm)', color: colors.green },
                { label: 'SNR (dB)', color: colors.cyan }
            ]);
        }
        
        function createChart(canvasId, label, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: label,
                        data: [],
                        borderColor: color,
                        backgroundColor: color + '15',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#aaa', font: { size: 10 } }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#aaa', font: { size: 9 } }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#aaa', font: { size: 9 } }
                        }
                    }
                }
            });
        }
        
        function createMultiChart(canvasId, datasets) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: datasets.map(ds => ({
                        label: ds.label,
                        data: [],
                        borderColor: ds.color,
                        backgroundColor: ds.color + '15',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false,
                        pointRadius: 0
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#aaa', font: { size: 10 } }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#aaa', font: { size: 9 } }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#aaa', font: { size: 9 } }
                        }
                    }
                }
            });
        }
        
        function addDataToChart(chartObj, values) {
            if (!chartObj) return;
            
            const now = new Date().toLocaleTimeString();
            chartObj.data.labels.push(now);
            
            if (Array.isArray(values)) {
                values.forEach((val, idx) => {
                    if (chartObj.data.datasets[idx]) {
                        chartObj.data.datasets[idx].data.push(val);
                    }
                });
            } else {
                chartObj.data.datasets[0].data.push(values);
            }
            
            if (chartObj.data.labels.length > maxDataPoints) {
                chartObj.data.labels.shift();
                chartObj.data.datasets.forEach(ds => ds.data.shift());
            }
            
            chartObj.update('none');
        }
        
        function switchMode(newMode) {
            mode = newMode;
            document.querySelectorAll('.controls button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        function resetLayout() {
            localStorage.removeItem('gridstackLayout');
            location.reload();
        }
        
        function saveLayout() {
            const layout = grid.save();
            localStorage.setItem('gridstackLayout', JSON.stringify(layout));
        }
        
        function loadLayout() {
            const saved = localStorage.getItem('gridstackLayout');
            if (saved) {
                grid.load(JSON.parse(saved));
            }
        }
        
        function startRecording() {
            console.log('Recording started');
        }
        
        function stopRecording() {
            console.log('Recording stopped');
        }
        
        socket.on('connect', () => {
            document.getElementById('connectionStatus').textContent = '‚óè Connected';
            document.getElementById('connectionStatus').className = 'connection-status connected';
        });
        
        socket.on('disconnect', () => {
            document.getElementById('connectionStatus').textContent = '‚äò Disconnected';
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
        });
        
        socket.on('telemetry', (data) => {
            if (mode !== 'live') return;
            
            document.getElementById('speed').textContent = Math.round(data.sebesseg);
            document.getElementById('throttle').textContent = Math.round(data.aps) + '%';
            document.getElementById('gear').textContent = data.fokozat === 0 ? 'N' : data.fokozat;
            document.getElementById('rssi').textContent = Math.round(data.rssi);
            
            addDataToChart(charts.speed, [data.sebesseg, data.aps]);
            addDataToChart(charts.temp, [data.agt, data.egt, data.vizho, data.olajh]);
            addDataToChart(charts.fuel, [data.uzemanyagny, data.lambda * 100]);
            addDataToChart(charts.accel, data.gyorsulas);
            addDataToChart(charts.pressure, [data.olajnyomas, data.feknyomas]);
            addDataToChart(charts.signal, [data.rssi, data.snr]);
        });
        const widgetConfigs = {
            speed: { title: 'üèÅ Speed & Throttle', w: 6, h: 4, chart: 'speed' },
            temp: { title: 'üîß Engine Temps', w: 6, h: 4, chart: 'temp' },
            fuel: { title: 'üå°Ô∏è Fuel & Lambda', w: 6, h: 4, chart: 'fuel' },
            accel: { title: 'üí® Acceleration', w: 6, h: 4, chart: 'accel' },
            pressure: { title: 'üõ¢Ô∏è Oil & Brake', w: 6, h: 4, chart: 'pressure' },
            signal: { title: 'üì° Signal Quality', w: 6, h: 4, chart: 'signal' }
        };

        function toggleToolbar() {
            const panel = document.getElementById('toolbarPanel');
            panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
        }

        function addWidget(widgetType, title) {
            const config = widgetConfigs[widgetType];
            const container = document.querySelector('.grid-stack');
            
            // Create unique canvas ID
            const canvasId = `${widgetType}-${Date.now()}`;
            
            // Create widget HTML
            const widget = document.createElement('div');
            widget.className = 'grid-stack-item';
            widget.setAttribute('gs-w', config.w);
            widget.setAttribute('gs-h', config.h);
            widget.innerHTML = `
                <div class="grid-stack-item-content">
                    <div class="chart-title">
                        ${config.title}
                        <button class="remove-widget" onclick="removeWidget(this)" style="float: right; background: #ff3333; padding: 2px 6px; border: none; color: white; cursor: pointer; font-size: 10px; border-radius: 3px;">√ó</button>
                    </div>
                    <div class="chart-wrapper"><canvas id="${canvasId}"></canvas></div>
                </div>
            `;
            
            container.appendChild(widget);
            grid.addWidget(widget, { w: config.w, h: config.h });
            
            // Initialize chart for this widget
            setTimeout(() => {
                const chartObj = createChart(canvasId, config.title, colors.blue);
                charts[canvasId] = { ...charts[config.chart], canvas: chartObj };
            }, 100);
            
            saveLayout();
        }

        function removeWidget(btn) {
            const widget = btn.closest('.grid-stack-item');
            grid.removeWidget(widget);
            saveLayout();
        }        
    </script>
</body>
</html>