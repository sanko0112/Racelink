<!DOCTYPE html>
<html>
<head>
    <title>Formula Student Telemetry - Golden Layout</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://golden-layout.com/files/latest/css/goldenlayout-base.css" />
    <link rel="stylesheet" href="https://golden-layout.com/files/latest/css/goldenlayout-dark-theme.css" />
    <script src="https://golden-layout.com/files/latest/js/goldenlayout.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #fff;
        }
        
        .header {
            background: #0a0a0a;
            padding: 15px;
            border-bottom: 2px solid #031fe6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .header-logo {
            height: 50px;
        }
        
        .header-title {
            color: #031fe6;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 0 10px #031fe6;
        }
        
        .status-bar {
            display: flex;
            gap: 20px;
            padding: 10px 20px;
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        
        .status-value {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            font-family: 'Courier New', monospace;
        }
        
        .status-label {
            font-size: 10px;
            color: #aaa;
        }
        
        .connection-status {
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .connection-status.connected {
            background: #00ff88;
            color: #000;
        }
        
        .connection-status.disconnected {
            background: #ff3333;
            color: #fff;
        }
        
        #layoutContainer {
            position: absolute;
            top: 120px;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        .lm_goldenlayout {
            background: #1a1a1a;
        }
        
        .lm_item {
            background: rgba(3, 31, 230, 0.05);
            border: 1px solid #333;
        }
        
        .lm_header {
            background: rgba(3, 31, 230, 0.2);
            border-bottom: 1px solid #333;
            color: #fff;
        }
        
        .lm_tab {
            color: #aaa;
        }
        
        .lm_tab.lm_active {
            color: #031fe6;
            border-bottom: 2px solid #031fe6;
        }
        
        .chart-wrapper {
            width: 100%;
            height: 100%;
            padding: 10px;
            overflow: auto;
            position: relative;
        }
        
        .chart-wrapper canvas {
            width: 100% !important;
            height: 100% !important;
        }
        
        .raw-data {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #00ff88;
            line-height: 1.5;
            overflow-y: auto;
            padding: 10px;
            height: 100%;
        }
        
        .raw-data-row {
            margin-bottom: 3px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.1);
            padding-bottom: 2px;
        }
        
        .raw-data-label {
            color: #aaa;
            width: 100px;
            display: inline-block;
        }
        
        .raw-data-value {
            color: #00ff88;
            font-weight: bold;
        }
        
        .map-container {
            width: 100%;
            height: 100%;
            background: #222;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <img src="/static/cropped-338345294_778307876971630_8269203501290917883_n-1.jpg" alt="Team Logo" class="header-logo">
            <div class="header-title">‚ö° RaceLink Telemetry</div>
        </div>
        <div class="status-bar">
            <div class="status-item">
                <div class="status-value" id="speed">0</div>
                <div class="status-label">km/h</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="throttle">0%</div>
                <div class="status-label">Throttle</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="gear">N</div>
                <div class="status-label">Gear</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="rssi">--</div>
                <div class="status-label">RSSI</div>
            </div>
            <div class="connection-status connected" id="connectionStatus">‚óè Connected</div>
        </div>
    </div>
    
    <div id="layoutContainer"></div>

    <script>
        const socket = io();
        let charts = {};
        const maxDataPoints = 50;
        
        const colors = {
            red: 'rgb(255, 99, 132)',
            blue: 'rgb(54, 162, 235)',
            yellow: 'rgb(255, 206, 86)',
            green: 'rgb(75, 192, 75)',
            purple: 'rgb(153, 102, 255)',
            orange: 'rgb(255, 159, 64)',
            cyan: 'rgb(75, 192, 192)',
            pink: 'rgb(255, 159, 192)'
        };
        
        var config = {
            settings: {
                hasHeaders: true,
                constrainDragToContainer: true,
                reorderEnabled: true,
                selectionEnabled: false,
                popoutButton: false,
                showPopoutIcon: false,
                showMaximiseIcon: true,
                showCloseIcon: true
            },
            dimensions: {
                headerHeight: 25,
                borderWidth: 3
            },
            content: [{
                type: 'row',
                content: [
                    {
                        type: 'column',
                        width: 25,
                        content: [
                            {
                                type: 'component',
                                componentName: 'raw-data',
                                title: 'üìã Raw Data'
                            },
                            {
                                type: 'component',
                                componentName: 'map',
                                title: 'üó∫Ô∏è Track Map'
                            }
                        ]
                    },
                    {
                        type: 'column',
                        width: 75,
                        content: [
                            {
                                type: 'stack',
                                content: [
                                    {
                                        type: 'component',
                                        componentName: 'chart',
                                        title: 'üèÅ Speed & Throttle',
                                        componentState: { chartType: 'speed' }
                                    },
                                    {
                                        type: 'component',
                                        componentName: 'chart',
                                        title: 'üîß Engine Temps',
                                        componentState: { chartType: 'temp' }
                                    },
                                    {
                                        type: 'component',
                                        componentName: 'chart',
                                        title: 'üì° Signal Quality',
                                        componentState: { chartType: 'signal' }
                                    },
                                    {
                                        type: 'component',
                                        componentName: 'chart',
                                        title: 'üå°Ô∏è Fuel & Lambda',
                                        componentState: { chartType: 'fuel' }
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }]
        };
        
        var layout = new GoldenLayout(config, $('#layoutContainer'));
        
        layout.registerComponent('chart', function(container, state) {
            var chartType = state.chartType;
            container.getElement().html('<div class="chart-wrapper"><canvas id="chart-' + chartType + '"></canvas></div>');
            
            container.on('open', function() {
                setTimeout(function() {
                    createChart(chartType);
                }, 100);
            });
        });
        
        layout.registerComponent('raw-data', function(container, state) {
            container.getElement().html('<div class="raw-data" id="rawDataDisplay"></div>');
        });
        
        layout.registerComponent('map', function(container, state) {
            container.getElement().html('<div class="map-container"><p>Track Map Placeholder</p></div>');
        });
        
        function createChart(chartType) {
            var canvasId = 'chart-' + chartType;
            var canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            var ctx = canvas.getContext('2d');
            
            var configs = {
                speed: {
                    datasets: [
                        { label: 'Speed (km/h)', color: colors.blue },
                        { label: 'Throttle (%)', color: colors.orange }
                    ]
                },
                temp: {
                    datasets: [
                        { label: 'AGT (¬∞C)', color: colors.red },
                        { label: 'EGT (¬∞C)', color: colors.orange },
                        { label: 'Water (¬∞C)', color: colors.blue },
                        { label: 'Oil (¬∞C)', color: colors.purple }
                    ]
                },
                fuel: {
                    datasets: [
                        { label: 'Fuel Level (%)', color: colors.green },
                        { label: 'Lambda', color: colors.yellow }
                    ]
                },
                signal: {
                    datasets: [
                        { label: 'RSSI (dBm)', color: colors.green },
                        { label: 'SNR (dB)', color: colors.cyan }
                    ]
                }
            };
            
            var cfg = configs[chartType];
            
            charts[chartType] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: cfg.datasets.map(ds => ({
                        label: ds.label,
                        data: [],
                        borderColor: ds.color,
                        backgroundColor: ds.color + '15',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: false,
                        pointRadius: 0
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#aaa', font: { size: 10 } }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#aaa', font: { size: 9 } }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#aaa', font: { size: 9 } }
                        }
                    }
                }
            });
        }
        
        layout.init();
        
        // Create initial charts
        setTimeout(() => {
            createChart('speed');
            createChart('temp');
            createChart('signal');
            createChart('fuel');
        }, 300);
        
        socket.on('connect', () => {
            document.getElementById('connectionStatus').textContent = '‚óè Connected';
            document.getElementById('connectionStatus').className = 'connection-status connected';
        });
        
        socket.on('disconnect', () => {
            document.getElementById('connectionStatus').textContent = '‚äò Disconnected';
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
        });
        
        function addDataToChart(chartObj, values) {
            if (!chartObj || !chartObj.data) return;
            
            const now = new Date().toLocaleTimeString();
            chartObj.data.labels.push(now);
            
            if (Array.isArray(values)) {
                values.forEach((val, idx) => {
                    if (chartObj.data.datasets[idx]) {
                        chartObj.data.datasets[idx].data.push(val);
                    }
                });
            }
            
            if (chartObj.data.labels.length > maxDataPoints) {
                chartObj.data.labels.shift();
                chartObj.data.datasets.forEach(ds => ds.data.shift());
            }
            
            chartObj.update('none');
        }
        
        socket.on('telemetry', (data) => {
            document.getElementById('speed').textContent = Math.round(data.sebesseg);
            document.getElementById('throttle').textContent = Math.round(data.aps) + '%';
            document.getElementById('gear').textContent = data.fokozat === 0 ? 'N' : data.fokozat;
            document.getElementById('rssi').textContent = Math.round(data.rssi);
            
            const rawDataHtml = `
                <div class="raw-data-row"><span class="raw-data-label">Speed:</span><span class="raw-data-value">${data.sebesseg.toFixed(1)} km/h</span></div>
                <div class="raw-data-row"><span class="raw-data-label">Throttle:</span><span class="raw-data-value">${data.aps.toFixed(1)}%</span></div>
                <div class="raw-data-row"><span class="raw-data-label">Gear:</span><span class="raw-data-value">${data.fokozat}</span></div>
                <div class="raw-data-row"><span class="raw-data-label">AGT:</span><span class="raw-data-value">${data.agt.toFixed(1)}¬∞C</span></div>
                <div class="raw-data-row"><span class="raw-data-label">EGT:</span><span class="raw-data-value">${data.egt.toFixed(0)}¬∞C</span></div>
                <div class="raw-data-row"><span class="raw-data-label">Water:</span><span class="raw-data-value">${data.vizho.toFixed(1)}¬∞C</span></div>
                <div class="raw-data-row"><span class="raw-data-label">Oil:</span><span class="raw-data-value">${data.olajh.toFixed(1)}¬∞C</span></div>
                <div class="raw-data-row"><span class="raw-data-label">Oil Press:</span><span class="raw-data-value">${data.olajnyomas.toFixed(1)} bar</span></div>
                <div class="raw-data-row"><span class="raw-data-label">Fuel:</span><span class="raw-data-value">${data.uzemanyagny.toFixed(1)}%</span></div>
                <div class="raw-data-row"><span class="raw-data-label">Lambda:</span><span class="raw-data-value">${data.lambda.toFixed(3)}</span></div>
                <div class="raw-data-row"><span class="raw-data-label">Brake:</span><span class="raw-data-value">${data.feknyomas.toFixed(0)} bar</span></div>
                <div class="raw-data-row"><span class="raw-data-label">Accel:</span><span class="raw-data-value">${data.gyorsulas.toFixed(2)}g</span></div>
                <div class="raw-data-row"><span class="raw-data-label">RSSI:</span><span class="raw-data-value">${data.rssi.toFixed(0)} dBm</span></div>
                <div class="raw-data-row"><span class="raw-data-label">SNR:</span><span class="raw-data-value">${data.snr.toFixed(1)} dB</span></div>
            `;
            document.getElementById('rawDataDisplay').innerHTML = rawDataHtml;
            
            addDataToChart(charts.speed, [data.sebesseg, data.aps]);
            addDataToChart(charts.temp, [data.agt, data.egt, data.vizho, data.olajh]);
            addDataToChart(charts.fuel, [data.uzemanyagny, data.lambda * 100]);
            addDataToChart(charts.signal, [data.rssi, data.snr]);
        });
    </script>
</body>
</html>